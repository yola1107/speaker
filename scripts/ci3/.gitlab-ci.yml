
  variables:
    REPO_HARBOR: "192.168.10.67"
    REPO_HARBOR_USER: "admin"
    REPO_HARBOR_PASS: "P8jF3sH6vQ1yL5nT"
    REPO_PATH: "egame"
    REPO_PROJECT: "egame-grpc03"
    IMAGE_VERSION: "local-dev-v0.0.1"
    DEPLOY_HOST: "192.168.10.87"
    DEPLOY_USER: "dzz"
    DEPLOY_PASSWORD: "Dzz12345!@#"

  stages:
    - build
    - deploy
  #ÈïúÂÉèÂÆåÊï¥Ë∑ØÂæÑ: 192.168.10.67/egame/egame-grpc03:local-dev-v0.0.1
  # ---------- Build Ê®°Êùø ----------
  .build_template: &build_template
    stage: build
    image: $REPO_HARBOR/$REPO_PATH/ci-tools:go1.24.5-podman
    script:
      - echo "üî® ÊûÑÂª∫ $APP_BINARY"
      - export STORAGE_DRIVER=vfs
      - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o $APP_BINARY .
      - echo "üì¶ ÊûÑÂª∫ÈïúÂÉè $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION"
      - podman login --tls-verify=false -u "$REPO_HARBOR_USER" -p "$REPO_HARBOR_PASS" $REPO_HARBOR
      - podman build --tls-verify=false -t $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION .
      - podman push --tls-verify=false $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION
      - rm -f $APP_BINARY
    only:
      - dzz/local-dev

  # ---------- Deploy Ê®°Êùø ----------
  .deploy_template: &deploy_template
    stage: deploy
    image: $REPO_HARBOR/$REPO_PATH/ci-tools:go1.24.5-podman
    before_script:
      - apk add --no-cache openssh-client sshpass
    script:
      - |
        sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
          # ÂàõÂª∫ÂøÖË¶ÅÁõÆÂΩïÂíåÈÖçÁΩÆÊñá‰ª∂
          echo '$DEPLOY_PASSWORD' | sudo -S mkdir -p $APP_PATH/{conf,logs} &&
          # Ê£ÄÊü•Âπ∂Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂Âà∞ËøúÁ´ØÊúçÂä°Âô®
          if [ ! -f $APP_PATH/conf/config_local.yaml ]; then
            echo 'ÈÖçÁΩÆÊñá‰ª∂ config_local.yaml ‰∏çÂ≠òÂú®Ôºå‰ªéÈïúÂÉè‰∏≠ÊèêÂèñ...'
            # ÊãâÂèñÊúÄÊñ∞ÁöÑÈïúÂÉè
            echo '$DEPLOY_PASSWORD' | sudo -S docker pull $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION &&
            # ‰∏¥Êó∂ËøêË°åÂÆπÂô®Âπ∂Â§çÂà∂ÈÖçÁΩÆÊñá‰ª∂
            TEMP_CONTAINER=\$(sudo docker create $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION) &&
            sudo docker cp \$TEMP_CONTAINER:/app/conf/config_local.yaml $APP_PATH/conf/config_local.yaml &&
            sudo docker rm -v \$TEMP_CONTAINER > /dev/null 2>&1
            echo 'Â∑≤‰ªéÈïúÂÉè‰∏≠ÊèêÂèñ config_local.yaml'
          else
            echo 'config_local.yaml Â∑≤Â≠òÂú®'
          fi &&
          # ÂêåÊ†∑Á°Æ‰øù config.yaml ‰πüÂ≠òÂú®
          if [ ! -f $APP_PATH/conf/config.yaml ]; then
            echo 'ÈÖçÁΩÆÊñá‰ª∂ config.yaml ‰∏çÂ≠òÂú®Ôºå‰ªéÈïúÂÉè‰∏≠ÊèêÂèñ...'
            if [ -n \"\$TEMP_CONTAINER\" ] && [ \"\$(sudo docker ps -aq -f id=\$TEMP_CONTAINER 2>/dev/null)\" ]; then
              sudo docker cp \$TEMP_CONTAINER:/app/conf/config.yaml $APP_PATH/conf/config.yaml 2>/dev/null || echo '{}' > $APP_PATH/conf/config.yaml
            else
              TEMP_CONTAINER_NEW=\$(sudo docker create $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION) &&
              sudo docker cp \$TEMP_CONTAINER_NEW:/app/conf/config.yaml $APP_PATH/conf/config.yaml &&
              sudo docker rm -v \$TEMP_CONTAINER_NEW > /dev/null 2>&1 || echo '{}' > $APP_PATH/conf/config.yaml
            fi
          fi &&
        
          # ÁôªÂΩï Harbor Âπ∂ÊãâÂèñÈïúÂÉè
          echo '$DEPLOY_PASSWORD' | sudo -S docker login --username $REPO_HARBOR_USER --password-stdin $REPO_HARBOR <<< '$REPO_HARBOR_PASS' &&
          echo '$DEPLOY_PASSWORD' | sudo -S docker pull $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION &&
        
          # ÂÅúÊ≠¢Âπ∂Âà†Èô§ÊóßÂÆπÂô®
          echo '$DEPLOY_PASSWORD' | sudo -S docker stop $CONTAINER_NAME 2>/dev/null || true &&
          echo '$DEPLOY_PASSWORD' | sudo -S docker rm $CONTAINER_NAME 2>/dev/null || true &&
        
          # ÂêØÂä®Êñ∞ÂÆπÂô®
          echo '$DEPLOY_PASSWORD' | sudo -S docker run -d --name $CONTAINER_NAME --restart=unless-stopped \
          -p $HOST_PORT:$CONTAINER_PORT -v $APP_PATH/conf:/app/conf -v $APP_PATH/logs:/app/logs \
          $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION &&
        
          # Ê£ÄÊü•Áä∂ÊÄÅ
          echo '$DEPLOY_PASSWORD' | sudo -S docker ps -a --filter name=$CONTAINER_NAME &&
          sleep 3 &&
          echo '$DEPLOY_PASSWORD' | sudo -S docker logs $CONTAINER_NAME | tail -5
        "
    only:
      - dzz/local-dev

  # ---------- ÊúçÂä°ÂàóË°® ----------
  # grpc03
  build-grpc03:
    <<: *build_template
    variables:
      APP_BINARY: "egame-grpc03.bin"
      PORT: "8889"
  deploy-grpc03:
    <<: *deploy_template
    variables:
      APP_BINARY: "egame-grpc03.bin"
      CONTAINER_NAME: "egame-grpc03-dev"
      HOST_PORT: "8889"
      CONTAINER_PORT: "8889"
      APP_PATH: "/home/dzz/egame-grpc03"
    needs:
      - job: build-grpc03



