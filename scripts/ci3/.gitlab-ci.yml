
  variables:
    REGISTRY: "192.168.10.67"
    USER: "admin"
    PASS: "P8jF3sH6vQ1yL5nT"
    DEPLOY_HOST: "192.168.10.87"
    DEPLOY_USER: "dzz"
    DEPLOY_PASSWORD: "Dzz12345!@#"
    IMAGE_VERSION: "local-dev-v0.0.1"

  stages:
    - build
    - deploy

  # ---------- Build æ¨¡æ¿ ----------
  .build_template: &build_template
    stage: build
    image: 192.168.10.67/egame/ci-tools:go1.24.5-podman
    script:
      - echo "ğŸ”¨ æ„å»º $APP_BINARY"
      - export STORAGE_DRIVER=vfs
      - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o $APP_BINARY .
      - echo "ğŸ“¦ ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨"
      - ls -la conf/
      - echo "ğŸ“¦ æ„å»ºé•œåƒ $APP_IMAGE:$IMAGE_VERSION"
      - podman login --tls-verify=false -u "$USER" -p "$PASS" $REGISTRY
      - podman build --tls-verify=false -t $REGISTRY/$APP_IMAGE:$IMAGE_VERSION .
      - podman push --tls-verify=false $REGISTRY/$APP_IMAGE:$IMAGE_VERSION
      - rm -f $APP_BINARY
    only:
      - dzz/local-dev

  # ---------- Deploy æ¨¡æ¿ ----------
  .deploy_template: &deploy_template
    stage: deploy
    image: 192.168.10.67/egame/ci-tools:go1.24.5-podman
    before_script:
      - apk add --no-cache openssh-client sshpass
    script:
      - |
        sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
          # åˆ›å»ºå¿…è¦ç›®å½•å’Œé…ç½®æ–‡ä»¶
          echo '$DEPLOY_PASSWORD' | sudo -S mkdir -p $APP_PATH/{conf,logs} &&
          # æ£€æŸ¥å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°è¿œç«¯æœåŠ¡å™¨
          if [ ! -f $APP_PATH/conf/config_local.yaml ]; then
            echo 'é…ç½®æ–‡ä»¶ config_local.yaml ä¸å­˜åœ¨ï¼Œä»é•œåƒä¸­æå–...'
            # æ‹‰å–æœ€æ–°çš„é•œåƒ
            echo '$DEPLOY_PASSWORD' | sudo -S docker pull $REGISTRY/$APP_IMAGE:$IMAGE_VERSION &&
            # ä¸´æ—¶è¿è¡Œå®¹å™¨å¹¶å¤åˆ¶é…ç½®æ–‡ä»¶
            TEMP_CONTAINER=\$(sudo docker create $REGISTRY/$APP_IMAGE:$IMAGE_VERSION) &&
            sudo docker cp \$TEMP_CONTAINER:/app/conf/config_local.yaml $APP_PATH/conf/config_local.yaml &&
            sudo docker rm -v \$TEMP_CONTAINER > /dev/null 2>&1
            echo 'å·²ä»é•œåƒä¸­æå– config_local.yaml'
          else
            echo 'config_local.yaml å·²å­˜åœ¨'
          fi &&
          # åŒæ ·ç¡®ä¿ config.yaml ä¹Ÿå­˜åœ¨
          if [ ! -f $APP_PATH/conf/config.yaml ]; then
            echo 'é…ç½®æ–‡ä»¶ config.yaml ä¸å­˜åœ¨ï¼Œä»é•œåƒä¸­æå–...'
            if [ -n \"\$TEMP_CONTAINER\" ] && [ \"\$(sudo docker ps -aq -f id=\$TEMP_CONTAINER 2>/dev/null)\" ]; then
              sudo docker cp \$TEMP_CONTAINER:/app/conf/config.yaml $APP_PATH/conf/config.yaml 2>/dev/null || echo '{}' > $APP_PATH/conf/config.yaml
            else
              TEMP_CONTAINER_NEW=\$(sudo docker create $REGISTRY/$APP_IMAGE:$IMAGE_VERSION) &&
              sudo docker cp \$TEMP_CONTAINER_NEW:/app/conf/config.yaml $APP_PATH/conf/config.yaml &&
              sudo docker rm -v \$TEMP_CONTAINER_NEW > /dev/null 2>&1 || echo '{}' > $APP_PATH/conf/config.yaml
            fi
          fi &&
        
          # ç™»å½• Harbor å¹¶æ‹‰å–é•œåƒ
          echo '$DEPLOY_PASSWORD' | sudo -S docker login --username $USER --password-stdin $REGISTRY <<< '$PASS' &&
          echo '$DEPLOY_PASSWORD' | sudo -S docker pull $REGISTRY/$APP_IMAGE:$IMAGE_VERSION &&
        
          # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
          echo '$DEPLOY_PASSWORD' | sudo -S docker stop $CONTAINER_NAME 2>/dev/null || true &&
          echo '$DEPLOY_PASSWORD' | sudo -S docker rm $CONTAINER_NAME 2>/dev/null || true &&
        
          # å¯åŠ¨æ–°å®¹å™¨
          echo '$DEPLOY_PASSWORD' | sudo -S docker run -d --name $CONTAINER_NAME --restart=unless-stopped \
          -p $HOST_PORT:$CONTAINER_PORT -v $APP_PATH/conf:/app/conf -v $APP_PATH/logs:/app/logs \
          $REGISTRY/$APP_IMAGE:$IMAGE_VERSION &&
        
          # æ£€æŸ¥çŠ¶æ€
          echo '$DEPLOY_PASSWORD' | sudo -S docker ps -a --filter name=$CONTAINER_NAME &&
          sleep 3 &&
          echo '$DEPLOY_PASSWORD' | sudo -S docker logs $CONTAINER_NAME | tail -5
        "
    only:
      - dzz/local-dev

  # ---------- æœåŠ¡åˆ—è¡¨ ----------
  # grpc03
  build-grpc03:
    <<: *build_template
    variables:
      APP_BINARY: "egame-grpc03.bin"
      APP_IMAGE: "egame/egame-grpc03"
      PORT: "8889"
  deploy-grpc03:
    <<: *deploy_template
    variables:
      APP_BINARY: "egame-grpc03.bin"
      APP_IMAGE: "egame/egame-grpc03"
      CONTAINER_NAME: "egame-grpc03-dev"
      HOST_PORT: "8889"
      CONTAINER_PORT: "8889"
      APP_PATH: "/home/dzz/egame-grpc03"
    needs:
      - job: build-grpc03



