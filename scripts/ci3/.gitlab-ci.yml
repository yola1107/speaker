
variables:
  REPO_HARBOR: "192.168.10.67"
  REPO_HARBOR_USER: "admin"
  REPO_HARBOR_PASS: "P8jF3sH6vQ1yL5nT"
  REPO_PATH: "egame"
  REPO_PROJECT: "egame-grpc03"
  DEPLOY_HOST: "192.168.10.87"
  DEPLOY_USER: "dzz"
  DEPLOY_PASSWORD: "Dzz12345!@#"
  IMAGE_VERSION: "local-dev-v0.0.1"

stages:
  - build
  - deploy

# 镜像完整路径: 192.168.10.67/egame/egame-grpc03:local-dev-v0.0.1

# ---------- Build 模板 ----------
.build_template: &build_template
  stage: build
  image: $REPO_HARBOR/$REPO_PATH/ci-tools:go1.24.5-podman
  script:
    - export STORAGE_DRIVER=vfs
    - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o $APP_BINARY .
    - podman login --tls-verify=false -u "$REPO_HARBOR_USER" -p "$REPO_HARBOR_PASS" $REPO_HARBOR
    - podman build --tls-verify=false -t $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION .
    - podman push --tls-verify=false $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION
    - rm -f $APP_BINARY
  only:
    - dzz/local-dev

# ---------- Deploy 模板 ----------
.deploy_template: &deploy_template
  stage: deploy
  image: $REPO_HARBOR/$REPO_PATH/ci-tools:go1.24.5-podman
  before_script:
    - apk add --no-cache openssh-client sshpass
  script:
    - |
      sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
        set -e
        echo '$DEPLOY_PASSWORD' | sudo -S mkdir -p $APP_PATH/{conf,logs}

        # 登录并拉取镜像
        echo '$REPO_HARBOR_PASS' | sudo -S docker login --username $REPO_HARBOR_USER --password-stdin $REPO_HARBOR
        echo '$DEPLOY_PASSWORD' | sudo -S docker pull $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION

        # 初始化配置（仅第一次）
        if [ ! -d $APP_PATH/conf ] || [ -z \"\$(ls -A $APP_PATH/conf 2>/dev/null)\" ]; then
          TMP=\$(echo '$DEPLOY_PASSWORD' | sudo -S docker create $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION)
          echo '$DEPLOY_PASSWORD' | sudo -S docker cp \$TMP:/app/conf/. $APP_PATH/conf/
          echo '$DEPLOY_PASSWORD' | sudo -S docker rm \$TMP
        fi

        # 停止旧容器
        echo '$DEPLOY_PASSWORD' | sudo -S docker stop $CONTAINER_NAME 2>/dev/null || true
        echo '$DEPLOY_PASSWORD' | sudo -S docker rm $CONTAINER_NAME 2>/dev/null || true

        # 启动新容器
        echo '$DEPLOY_PASSWORD' | sudo -S docker run -d \
          --name $CONTAINER_NAME \
          --restart=unless-stopped \
          -p $HOST_PORT:$CONTAINER_PORT \
          -v $APP_PATH/conf:/app/conf \
          -v $APP_PATH/logs:/app/logs \
          $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION

        echo '$DEPLOY_PASSWORD' | sudo -S docker ps --filter name=$CONTAINER_NAME
      "
  only:
    - dzz/local-dev

# ---------- 服务列表 ----------
build-grpc03:
  <<: *build_template
  variables:
    APP_BINARY: "egame-grpc03.bin"

deploy-grpc03:
  <<: *deploy_template
  variables:
    CONTAINER_NAME: "egame-grpc03-dev"
    HOST_PORT: "8889"
    CONTAINER_PORT: "8889"
    APP_PATH: "/home/dzz/egame-grpc03"
  needs:
    - job: build-grpc03



