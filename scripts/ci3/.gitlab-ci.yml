
variables:
  REPO_HARBOR: "192.168.10.67"
  REPO_HARBOR_USER: "admin"
  REPO_HARBOR_PASS: "P8jF3sH6vQ1yL5nT"
  REPO_PATH: "egame"
  REPO_PROJECT: "egame-grpc03"
  DEPLOY_USER: "dzz"
  DEPLOY_PASSWORD: "Dzz12345!@#"
  APP_PATH: "/home/dzz/egame-grpc03"

stages:
  - build
  - deploy

# ---------- Build 模板 ----------
.build_template: &build_template
  stage: build
  image: $REPO_HARBOR/$REPO_PATH/ci-tools:go1.24.5-podman
  script:
    - export STORAGE_DRIVER=vfs
    - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o $APP_BINARY .
    - podman login --tls-verify=false -u "$REPO_HARBOR_USER" -p "$REPO_HARBOR_PASS" $REPO_HARBOR
    - podman build --tls-verify=false -t $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION .
    - podman push --tls-verify=false $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION
    - rm -f $APP_BINARY

# ---------- Deploy 模板 ----------
.deploy_template: &deploy_template
  stage: deploy
  image: $REPO_HARBOR/$REPO_PATH/ci-tools:go1.24.5-podman
  before_script:
    - apk add --no-cache openssh-client sshpass
  script:
    - |
      sshpass -p "$DEPLOY_PASSWORD" ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "
        set -e
        echo '$DEPLOY_PASSWORD' | sudo -S mkdir -p $APP_PATH/{conf,logs}

        # 登录并拉取镜像
        echo '$REPO_HARBOR_PASS' | sudo -S docker login --username $REPO_HARBOR_USER --password-stdin $REPO_HARBOR
        echo '$DEPLOY_PASSWORD' | sudo -S docker pull $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION

        # 停止旧容器
        echo '$DEPLOY_PASSWORD' | sudo -S docker stop $CONTAINER_NAME 2>/dev/null || true
        echo '$DEPLOY_PASSWORD' | sudo -S docker rm $CONTAINER_NAME 2>/dev/null || true

        # 启动新容器
        echo '$DEPLOY_PASSWORD' | sudo -S docker run -d \
          --name $CONTAINER_NAME \
          --restart=unless-stopped \
          -p $HOST_PORT:$CONTAINER_PORT \
          -v $APP_PATH/logs:/app/logs \
          $REPO_HARBOR/$REPO_PATH/$REPO_PROJECT:$IMAGE_VERSION

        echo '$DEPLOY_PASSWORD' | sudo -S docker ps --filter name=$CONTAINER_NAME
      "

# ---------- 开发环境 (dzz/local-dev) ----------
build-local-dev:
  <<: *build_template
  variables:
    APP_BINARY: "egame-grpc03.bin"
    IMAGE_VERSION: "dev-v0.0.1"
  only:
    - dzz/local-dev

deploy-local-dev:
  <<: *deploy_template
  variables:
    IMAGE_VERSION: "dev-v0.0.1"
    CONTAINER_NAME: "egame-grpc03-${CI_COMMIT_REF_SLUG}"
    DEPLOY_HOST: "192.168.10.87"
    HOST_PORT: "8889"
    CONTAINER_PORT: "8889"
  only:
    - dzz/local-dev
  needs:
    - job: build-local-dev

# ---------- 测试环境 (dzz/local-test) ----------
build-local-test:
  <<: *build_template
  variables:
    APP_BINARY: "egame-grpc03.bin"
    IMAGE_VERSION: "test-v0.0.1"
  only:
    - dzz/local-test

deploy-local-test:
  <<: *deploy_template
  variables:
    IMAGE_VERSION: "test-v0.0.1"
    CONTAINER_NAME: "egame-grpc03-${CI_COMMIT_REF_SLUG}"
    DEPLOY_HOST: "192.168.10.88"
    HOST_PORT: "8889"
    CONTAINER_PORT: "8889"
  only:
    - dzz/local-test
  needs:
    - job: build-local-test



